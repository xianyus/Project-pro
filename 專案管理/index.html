<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>專業協作看板 - 終極功能整合版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>
    
    <script src="plugin.js"></script>
    <script src="calendar-plugin.js"></script>
    <script src="https://unpkg.com/@popperjs/core@2"></script>
    <script src="https://unpkg.com/tippy.js@6"></script>
    <link rel="stylesheet" href="https://unpkg.com/tippy.js@6/dist/tippy.css">
    <link rel="stylesheet" href="https://unpkg.com/tippy.js@6/themes/material.css">

    <style>
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .modal-overlay { background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); }
        .color-dot { width: 24px; height: 24px; border-radius: 6px; cursor: pointer; transition: all 0.2s; border: 2px solid transparent; }
        .color-dot.active { border-color: #6366f1; transform: scale(1.2); }
        .drag-placeholder { background-color: rgba(99, 102, 241, 0.05); border: 2px dashed #6366f1; border-radius: 0.75rem; margin-bottom: 1rem; }
        .list-placeholder { background-color: rgba(99, 102, 241, 0.1); border: 2px dashed #6366f1; border-radius: 1rem; width: 20rem; height: 80vh; flex-shrink: 0; }
        .dragging { opacity: 0.4; }
        .list-dragging { opacity: 0.5; }
        .tab-btn.active { border-bottom: 2px solid #6366f1; color: #6366f1; }
        #board-wrapper { cursor: grab; user-select: none; }
        #board-wrapper:active { cursor: grabbing; }
        .list-container, .card-item, button, input, select, textarea { cursor: default; }
        #calendar { max-height: 70vh; }
        .fc-event { cursor: pointer; border: none; padding: 2px 4px; }
    </style>
</head>
<body class="bg-slate-100 min-h-screen text-slate-800 overflow-hidden flex flex-col">

    <nav class="bg-white border-b p-4 flex justify-between items-center sticky top-0 z-50 shadow-sm">
        <div class="flex items-center gap-3">
            <div class="bg-indigo-600 p-2 rounded-lg text-white shadow-lg"><i class="fa-solid fa-square-poll-vertical text-lg"></i></div>
            <h1 class="text-xl font-bold tracking-tight text-slate-700">專案協作管理</h1>
        </div>
        <div class="flex items-center gap-3">
            <button onclick="toggleCalendarModal()" class="bg-slate-100 hover:bg-slate-200 text-slate-500 p-2.5 rounded-lg border border-slate-200" title="開啟日曆追蹤">
                <i class="fa-solid fa-calendar-days text-lg"></i>
            </button>
            <button onclick="openSettingsPortal()" class="bg-slate-100 hover:bg-slate-200 text-slate-500 p-2.5 rounded-lg border border-slate-200">
                <i class="fa-solid fa-gear text-lg"></i>
            </button>
            <button onclick="addList()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-5 py-2.5 rounded-lg text-sm font-bold shadow-md">+ 新增看板</button>
        </div>
    </nav>

    <div id="board-wrapper" class="flex-1 overflow-x-auto no-scrollbar py-10">
        <div id="board" class="flex flex-row gap-6 px-6 items-start min-w-max h-full" ondragover="handleBoardDragOver(event)"></div>
    </div>

    <div id="calendarModal" class="hidden fixed inset-0 z-[70] modal-overlay flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-5xl overflow-hidden">
            <div class="p-6 border-b flex justify-between items-center bg-slate-50">
                <h3 class="font-bold text-slate-700"><i class="fa-solid fa-calendar-check mr-2"></i>專案日期追蹤</h3>
                <button onclick="toggleCalendarModal()" class="text-slate-400 hover:text-slate-600"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            <div class="p-6">
                <div id="calendar"></div>
            </div>
        </div>
    </div>

    <div id="settingModal" class="hidden fixed inset-0 z-[60] modal-overlay flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden">
            <div class="p-6 border-b flex justify-between items-center bg-slate-50">
                <h3 class="font-bold text-slate-700">看板偏好設定</h3>
                <button onclick="document.getElementById('settingModal').classList.add('hidden')" class="text-slate-400 hover:text-slate-600"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="flex border-b text-sm font-bold text-slate-400">
                <button id="tab-data" onclick="switchTab('data')" class="tab-btn flex-1 py-3 active">資料管理</button>
                <button id="tab-font" onclick="switchTab('font')" class="tab-btn flex-1 py-3">視覺樣式</button>
            </div>
            <div class="p-6 max-h-[60vh] overflow-y-auto">
                <div id="panel-data" class="space-y-6">
                    <section><label class="text-[10px] font-bold text-slate-400 uppercase mb-2 block">負責人清單</label><div id="ownerSettings" class="space-y-2 mb-3"></div><div class="flex gap-2"><input id="newOwnerInput" type="text" class="flex-1 border rounded-lg px-3 py-2 text-sm" placeholder="新負責人姓名"><button onclick="addOption('owners')" class="bg-indigo-600 text-white px-3 rounded-lg text-sm">新增</button></div></section>
                    <section><label class="text-[10px] font-bold text-slate-400 uppercase mb-2 block">標籤清單</label><div id="labelSettings" class="space-y-2 mb-3"></div><div class="flex gap-2"><input id="newLabelInput" type="text" class="flex-1 border rounded-lg px-3 py-2 text-sm" placeholder="新標籤名稱"><button onclick="addOption('labels')" class="bg-indigo-600 text-white px-3 rounded-lg text-sm">新增</button></div></section>
                </div>
                <div id="panel-font" class="hidden space-y-6">
                    <section><label class="text-[10px] font-bold text-slate-400 uppercase mb-2 block">看板標題字體 (px)</label><input id="input-list-font" type="number" onchange="updateFontSize('list', this.value)" class="w-full border rounded-lg px-3 py-2 text-sm"></section>
                    <section><label class="text-[10px] font-bold text-slate-400 uppercase mb-2 block">卡片內容字體 (px)</label><input id="input-card-font" type="number" onchange="updateFontSize('card', this.value)" class="w-full border rounded-lg px-3 py-2 text-sm"></section>
                </div>
            </div>
        </div>
    </div>

    <div id="cardModal" class="hidden fixed inset-0 z-50 modal-overlay flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl overflow-hidden">
            <div id="modalBar" class="h-4 w-full bg-yellow-400"></div>
            <div class="p-8">
                <div class="flex justify-between items-start mb-8">
                    <input id="editTitle" type="text" class="text-2xl font-black w-full border-none focus:ring-0 rounded p-1" placeholder="任務標題">
                    <button onclick="closeModal()" class="text-slate-300 hover:text-slate-600"><i class="fa-solid fa-circle-xmark text-2xl"></i></button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-10">
                    <div class="md:col-span-2 space-y-8">
                        <div><label class="text-[11px] font-black text-slate-400 uppercase mb-3 block">任務詳細描述</label><textarea id="editDesc" rows="5" class="w-full border rounded-xl p-4 text-sm bg-slate-50 outline-none focus:ring-2 focus:ring-indigo-500" placeholder="在此輸入更多任務細節..."></textarea></div>
                        <div><label class="text-[11px] font-black text-slate-400 uppercase mb-4 block">卡片標識顏色</label><div id="colorPicker" class="grid grid-cols-10 gap-2"></div></div>
                    </div>
                    <div class="space-y-5 bg-slate-50 p-5 rounded-2xl border">
                        <div><label class="text-[10px] font-bold text-slate-400 uppercase">負責業務</label><select id="editOwner" class="w-full border rounded-lg px-3 py-2 text-sm bg-white"></select></div>
                        <div><label class="text-[10px] font-bold text-slate-400 uppercase">狀態標籤</label><select id="editLabel" class="w-full border rounded-lg px-3 py-2 text-sm font-bold text-indigo-600 bg-white"></select></div>
                        <div><label class="text-[10px] font-bold text-slate-400 uppercase">截止日期</label><input id="editDate" type="date" class="w-full border rounded-lg px-3 py-2 text-sm outline-none"></div>
                        <div class="pt-6 space-y-3">
                            <button onclick="saveCardChanges()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-3 rounded-xl font-bold text-xs shadow-lg transition-colors">儲存變更</button>
                            <button id="btnDeleteCard" class="w-full text-red-400 hover:text-red-600 py-2 font-bold text-[10px] uppercase">刪除此張卡片</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let lists = JSON.parse(localStorage.getItem('trello_v6')) || [{ id: 'l1', title: '待處理', cards: [] }];
        let currentEdit = null, draggedCard = null, draggedListId = null;

        const wrapper = document.getElementById('board-wrapper');
        let isDown = false, startX, scrollLeft;
        wrapper.addEventListener('mousedown', (e) => { if (e.target.id !== 'board-wrapper' && e.target.id !== 'board') return; isDown = true; startX = e.pageX - wrapper.offsetLeft; scrollLeft = wrapper.scrollLeft; });
        wrapper.addEventListener('mouseleave', () => { isDown = false; });
        wrapper.addEventListener('mouseup', () => { isDown = false; });
        wrapper.addEventListener('mousemove', (e) => { if (!isDown) return; e.preventDefault(); const x = e.pageX - wrapper.offsetLeft; wrapper.scrollLeft = scrollLeft - (x - startX) * 2; });

        function renderBoard() {
            const board = document.getElementById('board');
            board.innerHTML = '';
            const config = getPluginConfig();
            lists.forEach(list => {
                const el = document.createElement('div');
                el.className = "list-container bg-slate-200/50 rounded-2xl w-80 p-4 flex-shrink-0 flex flex-col max-h-[80vh] border shadow-inner";
                el.draggable = true;
                el.dataset.listId = list.id;
                el.ondragstart = (e) => { if (e.target.classList.contains('list-container')) { draggedListId = list.id; e.target.classList.add('list-dragging'); } };
                el.ondragend = (e) => { e.target.classList.remove('list-dragging'); document.querySelectorAll('.list-placeholder, .drag-placeholder').forEach(p => p.remove()); };
                el.ondragover = (e) => handleCardDragOver(e, list.id);
                el.ondrop = (e) => dropCard(e, list.id);
                el.innerHTML = `
                    <div class="flex justify-between items-center mb-4 px-1 cursor-move">
                        <h2 onclick="renameList('${list.id}')" class="font-black text-slate-500 uppercase hover:text-indigo-600 transition-colors cursor-pointer" style="font-size: ${config.listFontSize}px">${list.title}</h2>
                        <button onclick="deleteList('${list.id}')" class="text-slate-300 hover:text-red-400"><i class="fa-solid fa-trash-can text-xs"></i></button>
                    </div>
                    <div class="card-list space-y-4 overflow-y-auto no-scrollbar flex-1">
                        ${list.cards.map(card => `
                            <div onclick="openModal('${list.id}', '${card.id}')" draggable="true" ondragstart="startCardDrag(event, '${card.id}', '${list.id}')"
                                 class="card-item bg-white rounded-xl shadow-sm border border-slate-100 cursor-pointer hover:shadow-xl transition-all overflow-hidden">
                                <div class="h-2.5 w-full" style="background-color: ${card.color}"></div>
                                <div class="p-4">
                                    <span class="bg-indigo-50 text-indigo-500 text-[9px] font-black px-2 py-0.5 rounded border mb-2 inline-block">${card.label}</span>
                                    <p class="text-slate-700 font-bold mb-4" style="font-size: ${config.cardFontSize}px">${card.text}</p>
                                    <div class="flex items-center justify-between text-[10px] text-slate-400 font-bold">
                                        <span class="bg-green-600 text-white px-2 py-0.5 rounded-full flex items-center gap-1"><i class="fa-regular fa-clock"></i> ${card.date}</span>
                                        <span>@${card.owner}</span>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    <button onclick="addNewCard('${list.id}')" class="mt-4 text-slate-400 font-bold py-2 border-2 border-dashed border-slate-300 rounded-xl hover:bg-white text-[11px]">+ 新增卡片</button>
                `;
                board.appendChild(el);
            });
        }

        function openModal(lid, cid) {
            const list = lists.find(l => l.id === lid);
            const card = list.cards.find(c => c.id === cid);
            currentEdit = { lid, cid, color: card.color };
            document.getElementById('editTitle').value = card.text;
            document.getElementById('editDesc').value = card.desc || '';
            document.getElementById('editDate').value = card.date;
            document.getElementById('modalBar').style.backgroundColor = card.color;
            const cfg = getPluginConfig();
            document.getElementById('editOwner').innerHTML = cfg.owners.map(o => `<option value="${o}" ${card.owner === o ? 'selected' : ''}>${o}</option>`).join('');
            document.getElementById('editLabel').innerHTML = cfg.labels.map(l => `<option value="${l}" ${card.label === l ? 'selected' : ''}>${l}</option>`).join('');
            const cols = ['#facc15', '#f87171', '#fb923c', '#4ade80', '#2dd4bf', '#38bdf8', '#818cf8', '#c084fc', '#f472b6', '#94a3b8', '#eab308', '#ef4444', '#f97316', '#22c55e', '#14b8a6', '#0ea5e9', '#6366f1', '#a855f7', '#ec4899', '#64748b'];
            document.getElementById('colorPicker').innerHTML = cols.map(c => `<div class="color-dot ${c === card.color ? 'active' : ''}" style="background-color: ${c}" onclick="setModalColor('${c}', event)"></div>`).join('');
            document.getElementById('btnDeleteCard').onclick = () => { if(confirm("刪除？")){ list.cards = list.cards.filter(c => c.id !== cid); saveAll(); closeModal(); } };
            document.getElementById('cardModal').classList.remove('hidden');
        }

        function setModalColor(c, e) { currentEdit.color = c; document.getElementById('modalBar').style.backgroundColor = c; document.querySelectorAll('.color-dot').forEach(d => d.classList.remove('active')); e.target.classList.add('active'); }
        function saveCardChanges() { const list = lists.find(l => l.id === currentEdit.lid); const card = list.cards.find(c => c.id === currentEdit.cid); card.text = document.getElementById('editTitle').value; card.desc = document.getElementById('editDesc').value; card.owner = document.getElementById('editOwner').value; card.label = document.getElementById('editLabel').value; card.date = document.getElementById('editDate').value; card.color = currentEdit.color; saveAll(); closeModal(); }
        function renameList(id) { const list = lists.find(l => l.id === id); const nt = prompt("名稱：", list.title); if (nt) { list.title = nt; saveAll(); } }
        function saveAll() { localStorage.setItem('trello_v6', JSON.stringify(lists)); renderBoard(); }
        function closeModal() { document.getElementById('cardModal').classList.add('hidden'); }
        function addList() { const t = prompt("名稱:"); if(t){lists.push({id:'l'+Date.now(), title:t, cards:[]}); saveAll();} }
        function deleteList(id) { if(confirm("確定刪除？")){lists = lists.filter(l=>l.id!==id); saveAll();} }
        
        function addNewCard(lid) {
            const cfg = getPluginConfig();
            const list = lists.find(l => l.id === lid);
            const nid = 'c' + Date.now();
            const today = new Date().toISOString().split('T')[0]; 
            list.cards.push({ id: nid, text: '新任務', label: cfg.labels[0], owner: cfg.owners[0], date: today, color: '#facc15', desc: '' });
            saveAll(); 
            openModal(lid, nid);
        }

        function openSettingsPortal() { initPluginUI(); document.getElementById('settingModal').classList.remove('hidden'); }
        function handleBoardDragOver(e) { if (draggedListId === null) return; e.preventDefault(); const board = document.getElementById('board'); const after = getDragAfterList(board, e.clientX); let ph = document.querySelector('.list-placeholder') || document.createElement('div'); ph.className = 'list-placeholder'; if (after == null) board.appendChild(ph); else board.insertBefore(ph, after); }
        function getDragAfterList(container, x) { const drs = [...container.querySelectorAll('.list-container:not(.list-dragging)')]; return drs.reduce((c, child) => { const box = child.getBoundingClientRect(); const offset = x - box.left - box.width / 2; if (offset < 0 && offset > c.offset) return { offset, element: child }; else return c; }, { offset: Number.NEGATIVE_INFINITY }).element; }
        document.getElementById('board').ondrop = (e) => { if (draggedListId === null) return; const ph = document.querySelector('.list-placeholder'); if (!ph) return; const ni = Array.from(document.getElementById('board').children).indexOf(ph); const oi = lists.findIndex(l => l.id === draggedListId); const [item] = lists.splice(oi, 1); lists.splice(ni > oi ? ni - 1 : ni, 0, item); draggedListId = null; saveAll(); };
        function startCardDrag(e, cid, lid) { e.stopPropagation(); draggedCard = { cid, lid }; e.target.classList.add('dragging'); }
        function handleCardDragOver(e, lid) { if (draggedCard === null) return; e.preventDefault(); e.stopPropagation(); const cl = e.currentTarget.querySelector('.card-list'); const after = getDragAfterCard(cl, e.clientY); let ph = document.querySelector('.drag-placeholder') || document.createElement('div'); ph.className = 'drag-placeholder'; ph.style.height = '100px'; if (after == null) cl.appendChild(ph); else cl.insertBefore(ph, after); }
        function getDragAfterCard(container, y) { const drs = [...container.querySelectorAll('.card-item:not(.dragging)')]; return drs.reduce((c, child) => { const box = child.getBoundingClientRect(); const offset = y - box.top - box.height / 2; if (offset < 0 && offset > c.offset) return { offset, element: child }; else return c; }, { offset: Number.NEGATIVE_INFINITY }).element; }
        function dropCard(e, lid) { if (draggedCard === null) return; e.preventDefault(); e.stopPropagation(); const fl = lists.find(l => l.id === draggedCard.lid), tl = lists.find(l => l.id === lid); const idx = fl.cards.findIndex(c => c.id === draggedCard.cid); const [item] = fl.cards.splice(idx, 1); const ph = e.currentTarget.querySelector('.drag-placeholder'); const pi = ph ? Array.from(e.currentTarget.querySelector('.card-list').children).indexOf(ph) : -1; if (pi === -1) tl.cards.push(item); else tl.cards.splice(pi, 0, item); draggedCard = null; saveAll(); }

        renderBoard();
    </script>
</body>
</html>